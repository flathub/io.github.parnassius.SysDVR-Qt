app-id: io.github.parnassius.SysDVR-Qt
runtime: org.kde.Platform
runtime-version: 5.15-23.08
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.dotnet8

command: sysdvr-qt-wrapper
finish-args:
  - --device=all
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --filesystem=xdg-pictures/SysDVR:create
  - --filesystem=xdg-videos/SysDVR:create

modules:
  - shared-modules/libusb/libusb.json

  - name: ffmpeg
    config-opts:
      - --disable-static
      - --enable-shared
      - --disable-programs
      - --disable-doc
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/ffmpeg
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-5.1.4.tar.xz
        sha256: 54383bb890a1cd62580e9f1eaa8081203196ed53bde9e98fb6b0004423f49063
        x-checker-data:
          type: anitya
          project-id: 5405
          stable-only: true
          versions: {<: '5.2'}
          url-template: https://ffmpeg.org/releases/ffmpeg-$version.tar.xz

  - name: CimguiSDL2Cross
    buildsystem: cmake-ninja
    no-make-install: true
    subdir: cimgui
    post-install:
      - install -Dm644 cimgui.so /app/lib/cimgui.so
    sources:
      - type: git
        url: https://github.com/exelix11/CimguiSDL2Cross.git
        tag: r1
        commit: c8c3ab89d8da93c268e4fdcfb1d257af43b038c7
        x-checker-data:
          type: json
          url: https://api.github.com/repos/exelix11/CimguiSDL2Cross/tags
          tag-query: first | .name
          version-query: $tag

  - name: SysDVR-Client
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/dotnet8/bin
      append-ld-library-path: /usr/lib/sdk/dotnet8/lib
      env:
        PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/share/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:/usr/lib/sdk/dotnet8/lib/pkgconfig
        DOTNET_CLI_TELEMETRY_OPTOUT: '1'
        DOTNET_NOLOGO: '1'
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: '1'
      arch:
        aarch64:
          env:
            RUNTIME: linux-arm64
        x86_64:
          env:
            RUNTIME: linux-x64
    build-commands:
      - mkdir -p /app/bin
      - dotnet publish -c Release --source ./nuget-sources ./Client/Client.csproj
        --runtime $RUNTIME --self-contained true
      - cp -r ./Client/bin/Release/net8.0/$RUNTIME/publish /app/SysDVR-Client
      - ln -s /app/SysDVR-Client/SysDVR-Client /app/bin/SysDVR-Client
      - ln -s /usr/lib/x86_64-linux-gnu/libSDL2-2.0.so.0 /app/lib/libSDL2.so
      - ln -s /usr/lib/x86_64-linux-gnu/libSDL2_image-2.0.so.0 /app/lib/libSDL2_image.so
      - ln -s /usr/lib/x86_64-linux-gnu/libSDL2_mixer-2.0.so.0 /app/lib/libSDL2_mixer.so
      - ln -s /usr/lib/x86_64-linux-gnu/libSDL2_net-2.0.so.0 /app/lib/libSDL2_net.so
      - ln -s /usr/lib/x86_64-linux-gnu/libSDL2_ttf-2.0.so.0 /app/lib/libSDL2_ttf.so
    sources:
      - type: git
        url: https://github.com/exelix11/SysDVR.git
        # tag: v6.0
        commit: e18a70473c87ec9519ed5bbecb1403694a474292
        x-checker-data:
          type: json
          url: https://api.github.com/repos/exelix11/SysDVR/tags
          tag-query: first | .name
          version-query: $tag | sub("^v"; "")
      - nuget-sources.json

  - name: SysDVR-Qt
    buildsystem: qmake
    post-install:
      - install -Dm755 sysdvr-qt-wrapper.sh /app/bin/sysdvr-qt-wrapper
      - desktop-file-edit --set-key Exec --set-value sysdvr-qt-wrapper
        /app/share/applications/io.github.parnassius.SysDVR-Qt.desktop
    sources:
      - type: git
        url: https://github.com/Parnassius/SysDVR-Qt.git
        tag: 0.3.0
        commit: 084b3cf322171f65412b8c5d894c9d73010db916
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Parnassius/SysDVR-Qt/tags
          tag-query: first | .name
          version-query: $tag
      - type: patch
        path: metainfo.patch
      - type: file
        path: sysdvr-qt-wrapper.sh
